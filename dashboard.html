<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CashBook</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/style.css">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
    <meta name="theme-color" content="#1e88e5">
</head>
<body>
    <header class="dash-header">
        <div class="container">
            <div class="dash-header-left">
                <div>
                    <h1 data-key="dashboard">Dashboard</h1>
                    <p id="welcomeText">Welcome back!</p>
                </div>
            </div>
            <div class="dash-header-center">
                <nav class="dash-nav">
                    <a href="dashboard.html" class="nav-link active" data-key="dashboard">Dashboard</a>
                    <a href="report.html" class="nav-link" data-key="reports">Reports</a>
                    <a href="family.html" class="nav-link" data-key="family">Family</a>
                    <a href="profile.html" class="nav-link" data-key="profile">Profile</a>
                    <button id="logoutHeaderBtn" class="nav-link logout-btn">üö™ Logout</button>
                    <div class="theme-toggle nav-link" id="themeToggle">
                        <span>üåô</span>
                        <div class="theme-toggle-switch" id="themeSwitch"></div>
                        <span>‚òÄÔ∏è</span>
                    </div>
                </nav>
            </div>
            <div class="dash-header-right">
                <button id="mobileMenuButton" class="mobile-menu-button">‚ò∞</button>
                <div id="desktopActions" class="hidden">
                    <!-- Desktop actions moved to center nav -->
                </div>
            </div>
        </div>
    </header>
    </header>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h3>Menu</h3>
            <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="dashboard.html" class="active" data-key="dashboard">üìä Dashboard</a>
            <a href="report.html" data-key="reports">üìà Reports</a>
            <a href="family.html" data-key="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</a>
            <a href="profile.html" data-key="profile">üë§ Profile</a>
        </nav>
        <div class="mobile-menu-actions">
            <div class="theme-toggle" id="mobileThemeToggle">
                <span>üåô</span>
                <div class="theme-toggle-switch" id="mobileThemeSwitch"></div>
                <span>‚òÄÔ∏è</span>
            </div>
            <button id="langToggle" class="lang-btn">üåê English</button>
            <button id="logoutBtn" class="btn btn-error" data-key="logout">Logout</button>
        </div>
    </div>

    <main class="container">
        <!-- Balance Card -->
        <div class="balance-card">
            <div class="balance-amount" id="currentBalance">‡ß≥0.00</div>
            <div class="balance-label" data-key="currentBalance">Current Balance</div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="quick-action" id="addIncomeBtn">
                <div class="quick-action-icon">üí∞</div>
                <div class="quick-action-label" data-key="addIncome">Add Income</div>
            </div>
            <div class="quick-action" id="addExpenseBtn">
                <div class="quick-action-icon">üí∏</div>
                <div class="quick-action-label" data-key="addExpense">Add Expense</div>
            </div>
            <div class="quick-action" id="viewReportsBtn">
                <div class="quick-action-icon">üìä</div>
                <div class="quick-action-label" data-key="viewReports">View Reports</div>
            </div>
            <div class="quick-action" id="calendarBtn">
                <div class="quick-action-icon">üìÖ</div>
                <div class="quick-action-label" data-key="calendar">Calendar</div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title" data-key="recentTransactions">Recent Transactions</h3>
                <button id="refreshTransactions" class="btn btn-sm btn-secondary">üîÑ</button>
            </div>
            <div class="card-body transactions-container">
                <div id="transactionsList">
                    <div class="text-center text-secondary" data-key="noTransactions">No transactions yet</div>
                </div>
                <!-- Pagination Controls -->
                <div class="pagination-controls hidden" id="paginationControls">
                    <div class="pagination-info">
                        <span id="pageInfo">Page 1 of 1</span>
                    </div>
                    <div class="pagination-buttons">
                        <button id="prevPageBtn" class="btn btn-sm btn-secondary" disabled>‚Äπ Previous</button>
                        <button id="nextPageBtn" class="btn btn-sm btn-secondary" disabled>Next ‚Ä∫</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="card hidden" id="calendarSection">
            <div class="card-header">
                <h3 class="card-title" data-key="calendar">Calendar</h3>
                <div class="flex">
                    <button id="prevMonth" class="btn btn-sm btn-secondary">‚Äπ</button>
                    <span id="currentMonth" class="px-3 py-1"></span>
                    <button id="nextMonth" class="btn btn-sm btn-secondary">‚Ä∫</button>
                </div>
            </div>
            <div class="card-body">
                <div id="calendarView"></div>
            </div>
        </div>
    </main>

    <!-- Add Income Modal -->
    <div id="incomeModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-key="addIncome">Add Income</h3>
                <button class="modal-close" id="closeIncomeModal">√ó</button>
            </div>
            <div class="modal-body">
                <form id="incomeForm">
                    <div class="form-group">
                        <label for="incomeAmount" class="form-label" data-key="amount">Amount</label>
                        <input type="number" id="incomeAmount" class="form-input" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="incomeSource" class="form-label" data-key="source">Source</label>
                        <select id="incomeSource" class="form-select" required>
                            <option value="">Select source</option>
                            <option value="Salary">Salary</option>
                            <option value="Business">Business</option>
                            <option value="Investment">Investment</option>
                            <option value="Freelance">Freelance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="incomeDate" class="form-label" data-key="date">Date</label>
                        <input type="date" id="incomeDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="incomeNote" class="form-label" data-key="note">Note</label>
                        <textarea id="incomeNote" class="form-textarea" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelIncome">Cancel</button>
                <button type="submit" form="incomeForm" class="btn btn-success">Add Income</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="expenseModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-key="addExpense">Add Expense</h3>
                <button class="modal-close" id="closeExpenseModal">√ó</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="form-group">
                        <label for="expenseAmount" class="form-label" data-key="amount">Amount</label>
                        <input type="number" id="expenseAmount" class="form-input" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCategory" class="form-label" data-key="category">Category</label>
                        <select id="expenseCategory" class="form-select" required>
                            <option value="">Select category</option>
                            <option value="food">Food & Dining</option>
                            <option value="transport">Transportation</option>
                            <option value="shopping">Shopping</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="health">Health & Medical</option>
                            <option value="education">Education</option>
                            <option value="travel">Travel</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate" class="form-label" data-key="date">Date</label>
                        <input type="date" id="expenseDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseNote" class="form-label" data-key="note">Note</label>
                        <textarea id="expenseNote" class="form-textarea" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelExpense">Cancel</button>
                <button type="submit" form="expenseForm" class="btn btn-error">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="firebase-config.js"></script>
    <script src="js/calendar.js"></script>
    
    <!-- Theme initialization -->
    <script>
        // Initialize theme immediately
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        console.log('Theme initialized:', savedTheme);
    </script>
    
    <!-- Main dashboard script -->
    <script>
        // Firebase variables
        let auth, db, realtimeDB;
        let currentUser = null;
        
        // Initialize Firebase
        function initFirebase() {
            console.log('üî• Initializing Firebase...');
            
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            auth = firebase.auth();
            db = firebase.firestore();
            realtimeDB = firebase.database();
            
            console.log('‚úÖ Firebase initialized');
        }
        
        // Initialize theme toggle
        function initThemeToggle() {
            console.log('üé® Initializing theme toggle...');
            
            const themeToggle = document.getElementById('themeToggle');
            const themeSwitch = document.getElementById('themeSwitch');
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            const mobileThemeSwitch = document.getElementById('mobileThemeSwitch');
            
            function updateSwitches() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'dark') {
                    themeSwitch?.classList.add('active');
                    mobileThemeSwitch?.classList.add('active');
                } else {
                    themeSwitch?.classList.remove('active');
                    mobileThemeSwitch?.classList.remove('active');
                }
            }
            
            updateSwitches();
            
            [themeToggle, mobileThemeToggle].forEach(toggle => {
                if (toggle) {
                    toggle.addEventListener('click', () => {
                        console.log('üé® Theme toggle clicked');
                        const currentTheme = document.documentElement.getAttribute('data-theme');
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        
                        document.documentElement.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                        
                        updateSwitches();
                        console.log('üé® Theme changed to:', newTheme);
                    });
                }
            });
            
            console.log('‚úÖ Theme toggle initialized');
        }
        
        // Initialize mobile menu
        function initMobileMenu() {
            console.log('üì± Initializing mobile menu...');
            
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const mobileMenuClose = document.getElementById('mobileMenuClose');
            
            function openMobileMenu() {
                mobileMenu?.classList.add('active');
                mobileMenuOverlay?.classList.add('active');
                console.log('üì± Mobile menu opened');
            }
            
            function closeMobileMenu() {
                mobileMenu?.classList.remove('active');
                mobileMenuOverlay?.classList.remove('active');
                console.log('üì± Mobile menu closed');
            }
            
            mobileMenuButton?.addEventListener('click', openMobileMenu);
            mobileMenuClose?.addEventListener('click', closeMobileMenu);
            mobileMenuOverlay?.addEventListener('click', closeMobileMenu);
            
            console.log('‚úÖ Mobile menu initialized');
        }
        
        // Initialize logout
        function initLogout() {
            console.log('üö™ Initializing logout...');
            
            const logoutBtns = document.querySelectorAll('#logoutBtn, #logoutHeaderBtn');
            logoutBtns.forEach(btn => {
                btn.addEventListener('click', async () => {
                    console.log('üö™ Logout clicked');
                    try {
                        localStorage.clear();
                        sessionStorage.clear();
                        await auth.signOut();
                        console.log('‚úÖ Logout successful');
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('‚ùå Logout error:', error);
                        alert('Logout failed. Please try again.');
                    }
                });
            });
            
            console.log('‚úÖ Logout initialized');
        }
        
        // Initialize dashboard buttons
        function initDashboardButtons() {
            console.log('üî≤ Initializing dashboard buttons...');
            
            const addIncomeBtn = document.getElementById('addIncomeBtn');
            const addExpenseBtn = document.getElementById('addExpenseBtn');
            const viewReportsBtn = document.getElementById('viewReportsBtn');
            const calendarBtn = document.getElementById('calendarBtn');
            
            // Add Income button
            if (addIncomeBtn) {
                addIncomeBtn.addEventListener('click', () => {
                    console.log('üí∞ Add Income button clicked');
                    showModal('income');
                });
                console.log('‚úÖ Add Income button initialized');
            } else {
                console.error('‚ùå Add Income button not found');
            }
            
            // Add Expense button
            if (addExpenseBtn) {
                addExpenseBtn.addEventListener('click', () => {
                    console.log('üí∏ Add Expense button clicked');
                    showModal('expense');
                });
                console.log('‚úÖ Add Expense button initialized');
            } else {
                console.error('‚ùå Add Expense button not found');
            }
            
            // View Reports button
            if (viewReportsBtn) {
                viewReportsBtn.addEventListener('click', () => {
                    console.log('üìä View Reports clicked');
                    window.location.href = 'report.html';
                });
                console.log('‚úÖ View Reports button initialized');
            }
            
            // Calendar button
            if (calendarBtn) {
                calendarBtn.addEventListener('click', () => {
                    console.log('üìÖ Calendar clicked');
                    toggleCalendar();
                });
                console.log('‚úÖ Calendar button initialized');
            }
            
            console.log('‚úÖ Dashboard buttons initialized');
        }
        
        // Show modal function
        function showModal(type) {
            console.log(`üîß Attempting to show ${type} modal...`);
            const modal = document.getElementById(type + 'Modal');
            console.log(`üîß Modal element found:`, modal);
            if (modal) {
                modal.classList.remove('hidden');
                console.log(`‚úÖ ${type} modal opened successfully`);
            } else {
                console.error(`‚ùå ${type} modal not found!`);
            }
        }
        
        // Toggle calendar function
        function toggleCalendar() {
            const calendarSection = document.getElementById('calendarSection');
            if (calendarSection) {
                // Initialize calendar if it doesn't exist
                if (!window.calendarInstance) {
                    window.calendarInstance = new Calendar();
                }
                
                // Set current user and toggle calendar visibility
                if (window.calendarInstance) {
                    window.calendarInstance.setUser(currentUser);
                    window.calendarInstance.toggle();
                }
                
                console.log('Calendar toggled');
            }
        }
        
        // Initialize modal close buttons and form handling
        function initModals() {
            console.log('üìã Initializing modals...');
            
            // Set current date for date inputs
            const today = new Date();
            const localDateString = today.getFullYear() + '-' + 
                String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                String(today.getDate()).padStart(2, '0');
            
            console.log('üìÖ Setting form date to:', localDateString);
            document.getElementById('incomeDate').value = localDateString;
            document.getElementById('expenseDate').value = localDateString;
            
            // Close buttons
            const closeButtons = document.querySelectorAll('.modal-close, #closeIncomeModal, #closeExpenseModal');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    closeAllModals();
                });
            });
            
            // Cancel buttons
            const cancelButtons = document.querySelectorAll('#cancelIncome, #cancelExpense');
            cancelButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    closeAllModals();
                });
            });
            
            // Initialize form submissions
            initIncomeForm();
            initExpenseForm();
            
            console.log('‚úÖ Modals initialized');
        }
        
        // Close all modals
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.classList.add('hidden');
            });
            // Reset forms
            document.getElementById('incomeForm').reset();
            document.getElementById('expenseForm').reset();
            // Reset date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
        }
        
        // Initialize income form
        function initIncomeForm() {
            console.log('üí∞ Initializing income form...');
            
            const incomeForm = document.getElementById('incomeForm');
            if (!incomeForm) {
                console.error('‚ùå Income form not found!');
                return;
            }
            console.log('‚úÖ Income form element found:', incomeForm);
            
            incomeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üí∞ Income form submitted!');
                
                if (!currentUser) {
                    console.error('‚ùå No current user for income submission');
                    alert('Please login first');
                    return;
                }
                
                console.log('‚úÖ Current user verified:', currentUser.uid);
                
                // Get form data with validation
                const amountInput = document.getElementById('incomeAmount');
                const sourceInput = document.getElementById('incomeSource');
                const dateInput = document.getElementById('incomeDate');
                const noteInput = document.getElementById('incomeNote');
                
                console.log('üí∞ Form elements:', {
                    amount: amountInput?.value,
                    source: sourceInput?.value,
                    date: dateInput?.value,
                    note: noteInput?.value
                });
                
                if (!amountInput || !sourceInput || !dateInput) {
                    console.error('‚ùå Required form elements missing');
                    alert('Form elements are missing. Please refresh the page.');
                    return;
                }
                
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    console.error('‚ùå Invalid amount:', amountInput.value);
                    alert('Please enter a valid amount');
                    return;
                }
                
                const formData = {
                    amount: amount,
                    source: sourceInput.value,
                    date: new Date(dateInput.value + 'T00:00:00'), // Convert to Date object with local time
                    note: noteInput?.value || '',
                    type: 'income',
                    userId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: new Date() // Add client-side timestamp as backup
                };
                
                try {
                    // Show loading - find submit button by form attribute
                    const submitBtn = document.querySelector('button[form="incomeForm"][type="submit"]');
                    const originalText = submitBtn ? submitBtn.textContent : 'Add Income';
                    if (submitBtn) {
                        submitBtn.textContent = 'Saving...';
                        submitBtn.disabled = true;
                    }
                    
                    // Save to Firestore
                    console.log('üí∞ Saving income data:', formData);
                    const docRef = await db.collection('transactions').add(formData);
                    console.log('üí∞ Income saved with ID:', docRef.id);
                    
                    // Update balance in Realtime Database
                    await updateBalance(formData.amount, 'income');
                    
                    console.log('‚úÖ Income added successfully');
                    
                    // Reset form and close modal
                    closeAllModals();
                    
                    // Show success message
                    alert('Income added successfully!');
                    
                    // Refresh transactions and balance
                    console.log('üîÑ Refreshing data after income addition...');
                    console.log('üîÑ Current user for refresh:', currentUser?.uid);
                    console.log('üîÑ Transaction added at:', new Date().toISOString());
                    
                    // Wait a moment for server timestamp to be set, then refresh
                    setTimeout(async () => {
                        await loadTransactionsWithPagination();
                        await loadBalance();
                        console.log('üîÑ Refresh completed after income addition');
                    }, 1500);
                    
                    // Also do an immediate refresh
                    await loadTransactionsWithPagination();
                    await loadBalance();
                    
                    // Refresh calendar if it exists
                    if (window.calendarInstance) {
                        window.calendarInstance.refreshCalendar();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error adding income:', error);
                    console.error('Error details:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    let errorMessage = 'Error adding income. ';
                    if (error.code === 'permission-denied') {
                        errorMessage += 'Permission denied. Please check your authentication.';
                    } else if (error.code === 'unavailable') {
                        errorMessage += 'Database unavailable. Please check your internet connection.';
                    } else if (error.message) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += 'Please try again.';
                    }
                    
                    alert(errorMessage);
                } finally {
                    // Reset button
                    const submitBtn = document.querySelector('button[form="incomeForm"][type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'Add Income';
                        submitBtn.disabled = false;
                    }
                }
            });
            
            console.log('‚úÖ Income form initialized');
        }
        
        // Initialize expense form
        function initExpenseForm() {
            console.log('üí∏ Initializing expense form...');
            
            const expenseForm = document.getElementById('expenseForm');
            if (!expenseForm) {
                console.error('‚ùå Expense form not found!');
                return;
            }
            console.log('‚úÖ Expense form element found:', expenseForm);
            
            expenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('üí∏ Expense form submitted!');
                
                if (!currentUser) {
                    console.error('‚ùå No current user for expense submission');
                    alert('Please login first');
                    return;
                }
                
                console.log('‚úÖ Current user verified:', currentUser.uid);
                
                // Get form data with validation
                const amountInput = document.getElementById('expenseAmount');
                const categoryInput = document.getElementById('expenseCategory');
                const dateInput = document.getElementById('expenseDate');
                const noteInput = document.getElementById('expenseNote');
                
                console.log('üí∏ Form elements:', {
                    amount: amountInput?.value,
                    category: categoryInput?.value,
                    date: dateInput?.value,
                    note: noteInput?.value
                });
                
                if (!amountInput || !categoryInput || !dateInput) {
                    console.error('‚ùå Required form elements missing');
                    alert('Form elements are missing. Please refresh the page.');
                    return;
                }
                
                const amount = parseFloat(amountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    console.error('‚ùå Invalid amount:', amountInput.value);
                    alert('Please enter a valid amount');
                    return;
                }
                
                const formData = {
                    amount: amount,
                    category: categoryInput.value,
                    date: new Date(dateInput.value + 'T00:00:00'), // Convert to Date object with local time
                    note: noteInput?.value || '',
                    type: 'expense',
                    userId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: new Date() // Add client-side timestamp as backup
                };
                
                try {
                    // Show loading - find submit button by form attribute
                    const submitBtn = document.querySelector('button[form="expenseForm"][type="submit"]');
                    const originalText = submitBtn ? submitBtn.textContent : 'Add Expense';
                    if (submitBtn) {
                        submitBtn.textContent = 'Saving...';
                        submitBtn.disabled = true;
                    }
                    
                    // Save to Firestore
                    console.log('üí∏ Saving expense data:', formData);
                    const docRef = await db.collection('transactions').add(formData);
                    console.log('üí∏ Expense saved with ID:', docRef.id);
                    
                    // Update balance in Realtime Database
                    await updateBalance(formData.amount, 'expense');
                    
                    console.log('‚úÖ Expense added successfully');
                    
                    // Reset form and close modal
                    closeAllModals();
                    
                    // Show success message
                    alert('Expense added successfully!');
                    
                    // Refresh transactions and balance
                    console.log('üîÑ Refreshing data after expense addition...');
                    console.log('üîÑ Current user for refresh:', currentUser?.uid);
                    console.log('üîÑ Transaction added at:', new Date().toISOString());
                    
                    // Wait a moment for server timestamp to be set, then refresh
                    setTimeout(async () => {
                        await loadTransactionsWithPagination();
                        await loadBalance();
                        console.log('üîÑ Refresh completed after expense addition');
                    }, 1500);
                    
                    // Also do an immediate refresh
                    await loadTransactionsWithPagination();
                    await loadBalance();
                    
                    // Refresh calendar if it exists
                    if (window.calendarInstance) {
                        window.calendarInstance.refreshCalendar();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error adding expense:', error);
                    console.error('Error details:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    let errorMessage = 'Error adding expense. ';
                    if (error.code === 'permission-denied') {
                        errorMessage += 'Permission denied. Please check your authentication.';
                    } else if (error.code === 'unavailable') {
                        errorMessage += 'Database unavailable. Please check your internet connection.';
                    } else if (error.message) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += 'Please try again.';
                    }
                    
                    alert(errorMessage);
                } finally {
                    // Reset button
                    const submitBtn = document.querySelector('button[form="expenseForm"][type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'Add Expense';
                        submitBtn.disabled = false;
                    }
                }
            });
            
            console.log('‚úÖ Expense form initialized');
        }
        
        // Update balance in Realtime Database
        async function updateBalance(amount, type) {
            try {
                const userRef = realtimeDB.ref(`users/${currentUser.uid}`);
                const snapshot = await userRef.child('balance').once('value');
                const currentBalance = snapshot.val() || 0;
                
                let newBalance;
                if (type === 'income') {
                    newBalance = currentBalance + amount;
                } else {
                    newBalance = currentBalance - amount;
                }
                
                await userRef.child('balance').set(newBalance);
                console.log(`‚úÖ Balance updated: ${currentBalance} ‚Üí ${newBalance}`);
                
            } catch (error) {
                console.error('‚ùå Error updating balance:', error);
                throw error;
            }
        }
        
        // Load current balance
        async function loadBalance() {
            try {
                if (!currentUser) return;
                
                const userRef = realtimeDB.ref(`users/${currentUser.uid}/balance`);
                const snapshot = await userRef.once('value');
                const balance = snapshot.val() || 0;
                
                // Direct formatting function
                const formatBalanceDirectly = (amount) => {
                    const formattedNumber = Math.abs(amount).toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    const sign = amount < 0 ? '-' : '';
                    return `${sign}‡ß≥: ${formattedNumber}`;
                };
                
                const formattedBalance = formatBalanceDirectly(balance);
                document.getElementById('currentBalance').textContent = formattedBalance;
                console.log('‚úÖ Balance loaded:', formattedBalance);
                
            } catch (error) {
                console.error('‚ùå Error loading balance:', error);
            }
        }
        
        // Load recent transactions
        async function loadTransactions() {
            try {
                console.log('üîç Starting loadTransactions function...');
                
                const transactionsList = document.getElementById('transactionsList');
                console.log('üìã transactionsList element:', transactionsList);
                
                // Show loading state
                transactionsList.innerHTML = `
                    <div class="text-center text-secondary" style="padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>Loading transactions...</p>
                    </div>
                `;
                
                if (!currentUser && window.location.protocol !== 'file:') {
                    console.log('‚ùå No current user for transactions');
                    transactionsList.innerHTML = `
                        <div class="text-center text-secondary" style="padding: 2rem;">
                            <p>Please log in to view transactions</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('üìä Loading transactions for user:', currentUser?.uid || 'demo user');
                
                // For file:// protocol or demo, show sample data
                if (!currentUser || window.location.protocol === 'file:') {
                    console.log('üìä Showing sample data for demo');
                    
                    const sampleTransactions = [
                        {
                            title: 'education',
                            date: '7/18/2025',
                            note: 'bubt',
                            amount: 8001.00,
                            type: 'expense'
                        },
                        {
                            title: 'Salary',
                            date: '7/18/2025',
                            note: 'ewew',
                            amount: 2323.00,
                            type: 'income'
                        },
                        {
                            title: 'salary',
                            date: '7/18/2025',
                            note: 'fyv',
                            amount: 4455.00,
                            type: 'income'
                        }
                    ];
                    
                    const transactionsHTML = sampleTransactions.map(transaction => {
                        const amount = transaction.amount.toFixed(2);
                        const isIncome = transaction.type === 'income';
                        
                        return `
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${transaction.title}</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${transaction.date}</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${transaction.note}</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 600; color: ${isIncome ? 'var(--success)' : 'var(--error)'};">
                                    ${isIncome ? '+' : '-'}‡ß≥${amount}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    const tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: var(--card-background); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow);">
                            <thead>
                                <tr style="background: var(--surface-color);">
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Title</th>
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Date</th>
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Note</th>
                                    <th style="padding: 16px 12px; text-align: right; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactionsHTML}
                            </tbody>
                        </table>
                    `;
                    
                    transactionsList.innerHTML = tableHTML;
                    console.log('‚úÖ Sample transactions loaded with table layout');
                    return;
                }
                
                // For authenticated users, try to load real data
                try {
                    const snapshot = await db.collection('transactions')
                        .where('userId', '==', currentUser.uid)
                        .limit(10)
                        .get();
                    
                    console.log('üìä Transaction query result:', snapshot.size, 'documents');
                    
                    if (snapshot.empty) {
                        transactionsList.innerHTML = `
                            <div class="text-center text-secondary" style="padding: 2rem;">
                                <p>No transactions yet</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const transactionsHTML = snapshot.docs.map(doc => {
                        const data = doc.data();
                        
                        let date;
                        if (data.date) {
                            date = new Date(data.date).toLocaleDateString();
                        } else if (data.timestamp && data.timestamp.toDate) {
                            date = data.timestamp.toDate().toLocaleDateString();
                        } else {
                            date = 'Unknown date';
                        }
                        
                        const amount = data.amount ? data.amount.toFixed(2) : '0.00';
                        const isIncome = data.type === 'income';
                        const title = isIncome ? (data.source || 'Income') : (data.category || 'Expense');
                        const note = data.note || '';
                        
                        return `
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${title}</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${date}</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${note}</td>
                                <td style="padding: 12px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 600; color: ${isIncome ? 'var(--success)' : 'var(--error)'};">
                                    ${isIncome ? '+' : '-'}‡ß≥${amount}
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    const tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; background: var(--card-background); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow);">
                            <thead>
                                <tr style="background: var(--surface-color);">
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Title</th>
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Date</th>
                                    <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Note</th>
                                    <th style="padding: 16px 12px; text-align: right; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactionsHTML}
                            </tbody>
                        </table>
                    `;
                    
                    transactionsList.innerHTML = tableHTML;
                    console.log('‚úÖ Real transactions loaded with table layout');
                    
                } catch (error) {
                    console.error('‚ùå Error loading real transactions:', error);
                    transactionsList.innerHTML = `
                        <div class="text-center text-secondary" style="padding: 2rem;">
                            <div>Error loading transactions</div>
                            <div style="font-size: 0.8rem; color: var(--error);">${error.message}</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå Error loading transactions:', error);
                console.error('Error details:', error.code, error.message);
                
                // Show error message in UI
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = `
                    <div class="text-center text-secondary" style="padding: 2rem;">
                        <div>Error loading transactions</div>
                        <div style="font-size: 0.8rem; color: var(--error);">${error.message}</div>
                    </div>
                `;
            }
        }
        
        // Pagination variables
        let currentPage = 1;
        let transactionsPerPage = 7;
        let allTransactions = [];
        
        // Modified loadTransactions function for pagination
        async function loadTransactionsWithPagination() {
            try {
                console.log('üîç Starting loadTransactionsWithPagination function...');
                console.log('üîç Current user:', currentUser?.uid);
                console.log('üîç Window protocol:', window.location.protocol);
                console.log('üîç Current time:', new Date().toISOString());
                
                const transactionsList = document.getElementById('transactionsList');
                
                // Show loading state
                transactionsList.innerHTML = `
                    <div class="text-center text-secondary" style="padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>Loading transactions...</p>
                    </div>
                `;
                
                // For file:// protocol or when no user is authenticated, show demo data
                if (!currentUser || window.location.protocol === 'file:') {
                    console.log('üîß Loading demo data for file:// protocol or unauthenticated user');
                    
                    // Use sample data to demonstrate functionality
                    allTransactions = [
                        {
                            id: 'sample1',
                            title: 'education',
                            date: '7/18/2025',
                            note: 'bubt',
                            amount: 8001.00,
                            type: 'expense'
                        },
                        {
                            id: 'sample2',
                            title: 'Salary',
                            date: '7/18/2025',
                            note: 'ewew',
                            amount: 2323.00,
                            type: 'income'
                        },
                        {
                            id: 'sample3',
                            title: 'salary',
                            date: '7/18/2025',
                            note: 'fyv',
                            amount: 4455.00,
                            type: 'income'
                        },
                        {
                            id: 'sample4',
                            title: 'Freelance',
                            date: '7/18/2025',
                            note: '',
                            amount: 456464.00,
                            type: 'income'
                        },
                        {
                            id: 'sample5',
                            title: 'other',
                            date: '7/18/2025',
                            note: 'watch',
                            amount: 4000.00,
                            type: 'expense'
                        },
                        {
                            id: 'sample6',
                            title: 'food',
                            date: '7/18/2025',
                            note: 'school',
                            amount: 450.00,
                            type: 'expense'
                        },
                        {
                            id: 'sample7',
                            title: 'Freelance',
                            date: '7/18/2025',
                            note: '',
                            amount: 50.11,
                            type: 'income'
                        },
                        {
                            id: 'sample8',
                            title: 'salary',
                            date: '7/18/2025',
                            note: 'tiution',
                            amount: 1200.00,
                            type: 'income'
                        },
                        {
                            id: 'sample9',
                            title: 'transport',
                            date: '7/17/2025',
                            note: 'more',
                            amount: 500.00,
                            type: 'expense'
                        },
                        {
                            id: 'sample10',
                            title: 'Shopping',
                            date: '7/16/2025',
                            note: 'clothes',
                            amount: 2500.00,
                            type: 'expense'
                        },
                        {
                            id: 'sample11',
                            title: 'Bonus',
                            date: '7/15/2025',
                            note: 'performance',
                            amount: 5000.00,
                            type: 'income'
                        },
                        {
                            id: 'sample12',
                            title: 'Bills',
                            date: '7/14/2025',
                            note: 'electricity',
                            amount: 1200.00,
                            type: 'expense'
                        }
                    ];
                    
                    // Reset to first page
                    currentPage = 1;
                    
                    // Display the current page
                    displayTransactionsPage();
                    
                    return;
                }
                
                // For authenticated users with HTTP protocol, try to load real data
                if (currentUser) {
                    console.log('üìä Loading real transactions for authenticated user:', currentUser.uid);
                    
                    try {
                        // First try to order by timestamp, fallback to createdAt if needed
                        let snapshot;
                        try {
                            snapshot = await db.collection('transactions')
                                .where('userId', '==', currentUser.uid)
                                .orderBy('timestamp', 'desc')
                                .get();
                        } catch (orderError) {
                            console.log('üìä Timestamp ordering failed, trying createdAt:', orderError);
                            try {
                                snapshot = await db.collection('transactions')
                                    .where('userId', '==', currentUser.uid)
                                    .orderBy('createdAt', 'desc')
                                    .get();
                            } catch (createdAtError) {
                                console.log('üìä CreatedAt ordering failed, getting unordered:', createdAtError);
                                snapshot = await db.collection('transactions')
                                    .where('userId', '==', currentUser.uid)
                                    .get();
                            }
                        }
                        
                        console.log('üìä Found', snapshot.size, 'transactions for user');
                        console.log('üìä Raw snapshot data:', snapshot.docs.map(doc => ({
                            id: doc.id,
                            data: doc.data(),
                            timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : 'No timestamp',
                            createdAt: doc.data().createdAt
                        })));
                        
                        if (!snapshot.empty) {
                            allTransactions = snapshot.docs.map(doc => {
                                const data = doc.data();
                                
                                // Format date properly
                                let formattedDate;
                                if (data.date) {
                                    formattedDate = data.date;
                                } else if (data.timestamp && data.timestamp.toDate) {
                                    formattedDate = data.timestamp.toDate().toLocaleDateString();
                                } else if (data.createdAt) {
                                    formattedDate = data.createdAt.toLocaleDateString ? data.createdAt.toLocaleDateString() : new Date(data.createdAt).toLocaleDateString();
                                } else {
                                    formattedDate = new Date().toLocaleDateString();
                                }
                                
                                const transaction = {
                                    id: doc.id,
                                    title: data.type === 'income' ? (data.source || 'Income') : (data.category || 'Expense'),
                                    date: formattedDate,
                                    note: data.note || '',
                                    amount: data.amount || 0,
                                    type: data.type || 'expense',
                                    timestamp: data.timestamp || data.createdAt || new Date()
                                };
                                
                                console.log('üìä Processed transaction:', transaction);
                                return transaction;
                            });
                            
                            // Sort by timestamp in descending order (most recent first) as a backup
                            allTransactions.sort((a, b) => {
                                const timestampA = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                                const timestampB = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                                return timestampB - timestampA;
                            });
                            
                            console.log('‚úÖ Loaded', allTransactions.length, 'real transactions (ordered by most recent first)');
                            console.log('‚úÖ Final transaction list:', allTransactions);
                            currentPage = 1;
                            displayTransactionsPage();
                            return;
                        } else {
                            console.log('üìä No real transactions found, user has empty transaction history');
                            allTransactions = [];
                            currentPage = 1;
                            displayTransactionsPage();
                            return;
                        }
                    } catch (error) {
                        console.log('üìä Error loading real transactions, falling back to demo data:', error);
                        console.error('Error details:', error);
                    }
                }
                
                // Fallback to demo data
                console.log('üìä Using demo data as fallback');
                allTransactions = [
                    {
                        id: 'demo1',
                        title: 'Sample Income',
                        date: '7/18/2025',
                        note: 'Demo data',
                        amount: 1000.00,
                        type: 'income'
                    },
                    {
                        id: 'demo2',
                        title: 'Sample Expense',
                        date: '7/18/2025',
                        note: 'Demo expense',
                        amount: 500.00,
                        type: 'expense'
                    }
                ];
                
                currentPage = 1;
                displayTransactionsPage();
                
            } catch (error) {
                console.error('‚ùå Error loading transactions:', error);
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = `
                    <div class="text-center text-secondary" style="padding: 2rem; color: var(--error);">
                        <p>Error loading transactions</p>
                        <p style="font-size: 0.8rem;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Display transactions for current page
        function displayTransactionsPage() {
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = startIndex + transactionsPerPage;
            const pageTransactions = allTransactions.slice(startIndex, endIndex);
            
            const transactionsList = document.getElementById('transactionsList');
            const paginationControls = document.getElementById('paginationControls');
            
            if (pageTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="text-center text-secondary" style="padding: 2rem;">
                        <p>No transactions yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Add your first income or expense to get started!</p>
                    </div>
                `;
                paginationControls.classList.add('hidden');
                return;
            }
            
            // Generate table rows
            const transactionsHTML = pageTransactions.map(transaction => {
                const amount = transaction.amount.toFixed(2);
                const isIncome = transaction.type === 'income';
                
                return `
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${transaction.title}</td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${transaction.date}</td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--border-color);">${transaction.note}</td>
                        <td style="padding: 12px; border-bottom: 1px solid var(--border-color); text-align: right; font-weight: 600; color: ${isIncome ? 'var(--success)' : 'var(--error)'};">
                            ${isIncome ? '+' : '-'}‡ß≥${amount}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Generate complete table
            const tableHTML = `
                <table style="width: 100%; border-collapse: collapse; background: var(--card-background); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow);">
                    <thead>
                        <tr style="background: var(--surface-color);">
                            <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Title</th>
                            <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Date</th>
                            <th style="padding: 16px 12px; text-align: left; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Note</th>
                            <th style="padding: 16px 12px; text-align: right; font-weight: 600; color: var(--text-color); border-bottom: 2px solid var(--border-color);">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactionsHTML}
                    </tbody>
                </table>
            `;
            
            transactionsList.innerHTML = tableHTML;
            
            // Update pagination controls
            const totalPages = Math.ceil(allTransactions.length / transactionsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            
            // Show pagination controls if there are multiple pages
            if (totalPages > 1) {
                paginationControls.classList.remove('hidden');
            } else {
                paginationControls.classList.add('hidden');
            }
        }
        
        // Mobile responsive function to handle desktop actions visibility
        function handleMobileDesktopActions() {
            const desktopActions = document.getElementById('desktopActions');
            const mobileMenuButton = document.querySelector('.mobile-menu-button');
            
            function checkScreenSize() {
                const isMobile = window.innerWidth <= 768;
                
                if (desktopActions) {
                    if (isMobile) {
                        desktopActions.style.display = 'none';
                        desktopActions.style.visibility = 'hidden';
                        desktopActions.style.opacity = '0';
                    } else {
                        desktopActions.style.display = 'flex';
                        desktopActions.style.visibility = 'visible';
                        desktopActions.style.opacity = '1';
                    }
                }
                
                if (mobileMenuButton) {
                    mobileMenuButton.style.display = 'block';
                }
            }
            
            // Check on load
            checkScreenSize();
            
            // Check on resize
            window.addEventListener('resize', checkScreenSize);
        }
        
        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Dashboard loading...');
            
            // Initialize Firebase
            initFirebase();
            
            // Initialize UI components
            initThemeToggle();
            initMobileMenu();
            initLogout();
            initDashboardButtons();
            initModals();
            
            // Handle mobile responsive design
            handleMobileDesktopActions();
            
            // Check authentication
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('‚úÖ User authenticated:', user.email);
                    currentUser = user;
                    
                    // Load user data
                    await loadBalance();
                    await loadTransactionsWithPagination();
                    
                    // Set up real-time balance listener
                    const balanceRef = realtimeDB.ref(`users/${user.uid}/balance`);
                    balanceRef.on('value', (snapshot) => {
                        const balance = snapshot.val() || 0;
                        
                        // Direct formatting function
                        const formatBalanceDirectly = (amount) => {
                            const formattedNumber = Math.abs(amount).toLocaleString('en-IN', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            const sign = amount < 0 ? '-' : '';
                            return `${sign}‡ß≥: ${formattedNumber}`;
                        };
                        
                        const formattedBalance = formatBalanceDirectly(balance);
                        document.getElementById('currentBalance').textContent = formattedBalance;
                        console.log('Real-time balance updated:', formattedBalance);
                    });
                    
                    // Set up real-time transactions listener to detect new transactions
                    console.log('üîÑ Setting up real-time transaction listener...');
                    let isFirstLoad = true;
                    const transactionsRef = db.collection('transactions').where('userId', '==', user.uid);
                    transactionsRef.onSnapshot((snapshot) => {
                        console.log('üîÑ Transactions changed! New size:', snapshot.size);
                        console.log('üîÑ Change details:', snapshot.docChanges().map(change => ({
                            type: change.type,
                            id: change.doc.id,
                            data: change.doc.data()
                        })));
                        
                        // Auto-refresh transactions when changes are detected (skip first load)
                        if (!isFirstLoad && snapshot.docChanges().length > 0) {
                            console.log('üîÑ Auto-refreshing transactions due to changes...');
                            setTimeout(() => {
                                loadTransactionsWithPagination();
                            }, 1000); // Small delay to allow server to process
                        }
                        isFirstLoad = false;
                    });
                    
                    // Update welcome message
                    const welcomeElement = document.getElementById('welcomeText');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${user.displayName || user.email}!`;
                    }
                    
                } else {
                    console.log('‚ùå User not authenticated');
                    
                    // Check if we're using file:// protocol for demonstration
                    if (window.location.protocol === 'file:') {
                        console.log('üîß File protocol detected - showing demo data');
                        // Show demo data for file:// protocol
                        document.getElementById('welcomeText').textContent = 'Welcome back! (Demo Mode)';
                        
                        // Direct formatting function for demo balance
                        const demoBalance = 451541.11;
                        const formatBalanceDirectly = (amount) => {
                            const formattedNumber = Math.abs(amount).toLocaleString('en-IN', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                            const sign = amount < 0 ? '-' : '';
                            return `${sign}‡ß≥: ${formattedNumber}`;
                        };
                        
                        const formattedBalance = formatBalanceDirectly(demoBalance);
                        document.getElementById('currentBalance').textContent = formattedBalance;
                        console.log('Demo balance set:', formattedBalance);
                        
                        // Load sample transactions for demo
                        await loadTransactionsWithPagination();
                    } else {
                        // For HTTP protocol, redirect to login
                        window.location.href = 'login.html';
                    }
                }
            });
            
            // Add pagination event listeners
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        displayTransactionsPage();
                    }
                });
                console.log('‚úÖ Previous page button initialized');
            } else {
                console.error('‚ùå Previous page button not found');
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    const totalPages = Math.ceil(allTransactions.length / transactionsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayTransactionsPage();
                    }
                });
                console.log('‚úÖ Next page button initialized');
            } else {
                console.error('‚ùå Next page button not found');
            }
            
            // Initialize other functionality
            initRefreshButton();
            
            console.log('‚úÖ Dashboard fully initialized');
        });
        
        // Initialize refresh button
        function initRefreshButton() {
            const refreshBtn = document.getElementById('refreshTransactions');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    console.log('üîÑ Manual refresh button clicked...');
                    const originalText = refreshBtn.textContent;
                    refreshBtn.textContent = '‚è≥';
                    refreshBtn.disabled = true;
                    
                    try {
                        console.log('üîÑ Starting manual refresh...');
                        await loadTransactionsWithPagination();
                        await loadBalance();
                        
                        // Refresh calendar if it exists
                        if (window.calendarInstance) {
                            window.calendarInstance.refreshCalendar();
                        }
                        
                        console.log('‚úÖ Manual refresh completed');
                        
                        // Show brief success feedback
                        refreshBtn.textContent = '‚úÖ';
                        setTimeout(() => {
                            refreshBtn.textContent = originalText;
                        }, 1000);
                        
                    } catch (error) {
                        console.error('‚ùå Error during manual refresh:', error);
                        refreshBtn.textContent = '‚ùå';
                        setTimeout(() => {
                            refreshBtn.textContent = originalText;
                        }, 2000);
                    } finally {
                        refreshBtn.disabled = false;
                    }
                });
                console.log('‚úÖ Refresh button initialized');
            } else {
                console.error('‚ùå Refresh button not found');
            }
        }
        
        // Note: Calendar navigation is handled by the Calendar class itself
        // No additional event listeners needed for prevMonth/nextMonth buttons
    </script>
    
    <!-- Final balance formatting script -->
    <script>
        // Ensure balance is formatted correctly after page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const balanceElement = document.getElementById('currentBalance');
                if (balanceElement) {
                    const currentText = balanceElement.textContent;
                    console.log('Current balance text:', currentText);
                    
                    // Extract number from current text
                    const numberMatch = currentText.match(/[\d,.]+/);
                    if (numberMatch) {
                        const number = parseFloat(numberMatch[0].replace(/,/g, ''));
                        if (!isNaN(number)) {
                            const formatBalanceDirectly = (amount) => {
                                const formattedNumber = Math.abs(amount).toLocaleString('en-IN', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                });
                                const sign = amount < 0 ? '-' : '';
                                return `${sign}‡ß≥: ${formattedNumber}`;
                            };
                            
                            const formattedBalance = formatBalanceDirectly(number);
                            balanceElement.textContent = formattedBalance;
                            console.log('Final balance formatted:', formattedBalance);
                        }
                    }
                }
            }, 1000); // Wait 1 second to ensure all scripts are loaded
        });
    </script>
</body>
</html>
